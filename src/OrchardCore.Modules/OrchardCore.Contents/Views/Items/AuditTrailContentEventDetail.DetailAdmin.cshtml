@model AuditTrailContentEventDetailViewModel
@using OrchardCore.AuditTrail.ViewModels
@using OrchardCore.Contents.AuditTrail.Providers

@{
    var contentEvent = Model.ContentEvent;
    var contentItem = contentEvent.ContentItem;
    var versionNumber = contentEvent.VersionNumber;
    var latestVersionId = Model.LatestVersionId;
    var diffNodes = Model.DiffNodes;
}

<script asp-name="jsdiff" depends-on="jQuery" asp-src="~/OrchardCore.AuditTrail/Scripts/diff.min.js" debug-src="~/OrchardCore.AuditTrail/Scripts/diff.js" cdn-src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/4.0.2/diff.min.js" debug-cdn-src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/4.0.2/diff.js" type="text/javascript" version="4.0.2" at="Foot"></script>
<script depends-on="jsdiff" asp-src="~/OrchardCore.AuditTrail/Scripts/diff.min.js" debug-src="~/OrchardCore.AuditTrail/Scripts/diff.js" type="text/javascript" at="Foot"></script>

<div class="card mb-3">
    <div class="card-header" id="headingContent">
        <h6 class="mb-0">
            <button class="btn btn-link" data-toggle="collapse" data-target="#collapseContent" aria-expanded="true" aria-controls="collapseContent">
            @T["Content Item Details"]
        </button>
        </h6>
    </div>
    <div id="collapseContent" class="collapse show" aria-labelledby="headingContent" data-parent="#accordion">
        <div class="card-body py-0" >
            <table class="table table-sm table-hover mb-0">
                <tbody>
                    <tr>
                        <th class="border-top-0 w-25">@T["Content Item Id"]</th>
                        <td class="border-top-0">@contentItem.ContentItemId</td>
                    </tr>
                    <tr>
                        <th>@T["Content type"]</th>
                        <td>@contentItem.ContentType</td>
                    </tr>
                    <tr>
                        <th>@T["Display text"]</th>
                        @if (Model.AuditTrailEvent.Name == ContentAuditTrailEventProvider.Removed)
                        {
                            <td>@contentItem.DisplayText</td>
                        }
                        else
                        {
                            <td><a edit-for="@contentItem">@contentItem.DisplayText</a></td>
                        }
                    </tr>
                    <tr>
                        <th>@T["Version"]</th>
                        @if (contentItem.ContentItemVersionId == latestVersionId)
                        {
                            <td>@T["Version {0}", versionNumber]</td>
                        }
                        else
                        {
                            <td>
                                <a asp-route-area="OrchardCore.Contents"
                                asp-action="Display"
                                asp-controller="Content"
                                asp-route-versionNumber="@versionNumber"
                                asp-route-auditTrailEventId="@Model.AuditTrailEvent.EventId">
                                    @T["Version {0}", versionNumber]
                                </a>
                            </td>
                        }
                    </tr>
                    <tr>
                        <th>@T["Comment"]</th>
                        <td>@Model.AuditTrailEvent.Comment</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
@if (diffNodes != null && diffNodes.Any())
{
    <div class="card mb-3">
        <div class="card-header" id="headingDiff">
            <h6 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseDiff" aria-expanded="true" aria-controls="collapseDiff">
                    @T["Diff"]
                </button>
            </h6>
        </div>       
        <div id="collapseDiff" class="collapse show" aria-labelledby="headingDiff" data-parent="#accordion">
            <div class="card-body py-0">
                <div class="form-group mt-3 d-sm-flex justify-content-sm-around">
                    <div class="custom-control custom-switch">
                        <div class="d-inline-block" data-toggle="collapse" data-target="#beforeAfter" aria-expanded="false">
                            <input type="checkbox" class="custom-control-input" id="showBeforeAfter">
                            <label class="custom-control-label cursor-pointer" for="showBeforeAfter">@T["Show before / after"]</label>
                        </div>
                    </div>

                    <div class="custom-control custom-switch">
                        <div class="d-inline-block" data-toggle="collapse" data-target="#diff" aria-expanded="false">
                            <input type="checkbox" class="custom-control-input" id="showDiff" checked>
                            <label class="custom-control-label cursor-pointer" for="showDiff">@T["Show diff"]</label>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-striped table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">@T["Action"]</th>
                                <th scope="col">@T["Context"]</th>
                                <th class="collapse" scope="col" id="beforeAfter">@T["Before"]</th>
                                <th class="collapse" scope="col" id="beforeAfter">@T["After"]</th>
                                <th class="collapse show" scope="col" id="diff">@T["Diff"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var node in diffNodes)
                            {
                                <tr>
                                    <td>@node.Type.ToString()</td>
                                    <td>@node.Context</td>
                                    <td class="collapse" id="beforeAfter" data-previous>@node.Previous</td>
                                    <td class="collapse" id="beforeAfter" data-current>@node.Current</td>
                                    <td class="collapse show" id="diff" data-diff></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<script at="Foot" type="text/javascript">
    $(function () {
        var previous = [];
        var current = [];
        var i = 0;

        $('[data-previous]').each(function () {
            previous.push($(this).html());
        });

        $('[data-current]').each(function () {
            current.push($(this).html());
        });

        $('[data-diff]').each(function () {
            var diff = Diff.diffWords(previous[i], current[i]),
                display = $(this),
                fragment = document.createDocumentFragment();

            diff.forEach(function (part) {
                color = part.added ? 'green' :
                    part.removed ? 'red' : null;
                fontWeight = part.added ? 'bold' :
                    part.removed ? 'bold' : null;
                span = document.createElement('span');

                span.style.color = color;
                span.style.fontWeight = fontWeight;
                span.appendChild(document.createTextNode($("<textarea/>").html(part.value + '\u200b').text()));
                fragment.appendChild(span);
            });

            display.html(fragment);
            i++;
        });
    });
</script>
